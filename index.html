<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Gestione Attività</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Gestione Attività">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gestione">
    <meta name="theme-color" content="#f1f5f9">
    <link rel="manifest" href="/manifest.json">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Custom Styles -->
    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overscroll-behavior-y: none;
            -webkit-user-select: none;
            user-select: none;
        }
        input, textarea, select {
            -webkit-user-select: text;
            user-select: text;
        }
        * {
            -webkit-tap-highlight-color: transparent;
        }
        .thumbnail-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 0.375rem;
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-100">
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, StrictMode } = React;

        // =================================================================
        // TYPES
        // =================================================================
        const OrderStatus = {
            DaIniziare: 'Da Iniziare',
            InSvolgimento: 'In Svolgimento',
            Terminato: 'Terminato',
        };

        // =================================================================
        // HOOKS
        // =================================================================
        function useLocalStorage(key, initialValue) {
            const [storedValue, setStoredValue] = useState(() => {
                if (typeof window === 'undefined') {
                    return initialValue;
                }
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.error(error);
                    return initialValue;
                }
            });

            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    if (typeof window !== 'undefined') {
                        window.localStorage.setItem(key, JSON.stringify(valueToStore));
                    }
                } catch (error) {
                    console.error(error);
                }
            };

            return [storedValue, setValue];
        }

        // =================================================================
        // UTILS
        // =================================================================
        const resizeImage = (file, maxWidth, maxHeight) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (!e.target?.result) {
                        return reject(new Error("FileReader did not return a result."));
                    }
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        if (!ctx) {
                             return reject(new Error("Could not get canvas context."));
                        }
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        const formatCurrency = (value) => {
            if (value === null || value === undefined) return '—';
            return value.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });
        };

        const formatDate = (dateString) => {
            return new Date(dateString).toLocaleDateString('it-IT', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
            });
        };

        // =================================================================
        // ICONS
        // =================================================================
        const PlusIcon = () => (
            <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
            </svg>
        );
        const EditIcon = ({className = "h-5 w-5"}) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z" />
            </svg>
        );
        const TrashIcon = ({className = "h-5 w-5"}) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );
        const CloseIcon = () => (
            <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        );
        const SearchIcon = () => (
            <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        );
        const XCircleIcon = () => (
            <svg className="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );
        const LinkIcon = () => (
            <svg className="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
            </svg>
        );
        const CopyIcon = ({className = "h-5 w-5"}) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
        );
        const CameraIcon = () => (
            <svg className="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <path strokeLinecap="round" strokeLinejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );
        const MinusIcon = () => (
            <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M20 12H4" />
            </svg>
        );
        const PlusSmallIcon = () => (
            <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
            </svg>
        );
        const FileDownloadIcon = ({className = "h-5 w-5 mr-2"}) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                <path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
        );

        // =================================================================
        // GENERIC COMPONENTS
        // =================================================================
        const Modal = ({ title, onClose, children }) => {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4" aria-modal="true" role="dialog">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center p-5 border-b border-slate-200 sticky top-0 bg-white rounded-t-lg">
                            <h2 className="text-xl font-semibold text-slate-800">{title}</h2>
                            <button onClick={onClose} className="p-2 text-slate-400 hover:text-slate-600 rounded-full hover:bg-slate-100" aria-label="Close modal">
                                <CloseIcon />
                            </button>
                        </div>
                        <div className="overflow-y-auto">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const ImageLightbox = ({ imageUrl, onClose, metadata }) => {
            useEffect(() => {
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        onClose();
                    }
                };
                document.addEventListener('keydown', handleEscape);
                return () => document.removeEventListener('keydown', handleEscape);
            }, [onClose]);

            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-[100] p-4"
                    onClick={onClose}
                >
                    <div className="relative w-full h-full flex items-center justify-center">
                         <button
                            onClick={onClose}
                            className="absolute top-2 right-2 text-white hover:text-slate-300 p-2 z-10 bg-black bg-opacity-20 rounded-full"
                            aria-label="Close image viewer"
                        >
                            <CloseIcon />
                        </button>
                        <img 
                            src={imageUrl} 
                            alt="Ingrandimento" 
                            className="max-w-full max-h-full object-contain rounded-lg shadow-2xl"
                            onClick={(e) => e.stopPropagation()} 
                        />
                        {metadata && (
                            <div className="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white p-4 text-sm text-center">
                                {metadata}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // =================================================================
        // ORDERS VIEW
        // =================================================================
        const OrderFilterControls = ({ searchTerm, setSearchTerm, statusFilter, setStatusFilter, startDate, setStartDate, endDate, setEndDate }) => {
            const handleReset = () => {
                setSearchTerm(''); setStatusFilter('all'); setStartDate(''); setEndDate('');
            };
            const isFiltered = searchTerm || statusFilter !== 'all' || startDate || endDate;
            return (
                <div className="bg-white p-4 rounded-lg shadow mb-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div className="lg:col-span-2">
                            <label htmlFor="search" className="block text-sm font-medium text-slate-700">Cerca Cliente o Articolo</label>
                            <div className="relative mt-1">
                                <div className="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><SearchIcon /></div>
                                <input type="text" id="search" placeholder="Cerca..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="block w-full rounded-md border-slate-300 py-2 pl-10 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm border" />
                            </div>
                        </div>
                        <div>
                            <label htmlFor="statusFilter" className="block text-sm font-medium text-slate-700">Stato</label>
                            <select id="statusFilter" value={statusFilter} onChange={(e) => setStatusFilter(e.target.value)} className="mt-1 block w-full rounded-md border-slate-300 py-2 pl-3 pr-10 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm border">
                                <option value="all">Tutti gli stati</option>
                                {Object.values(OrderStatus).map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                        </div>
                        <div className="grid grid-cols-2 gap-2 md:col-span-2 lg:col-span-1">
                            <div>
                                <label htmlFor="startDate" className="block text-sm font-medium text-slate-700">Da</label>
                                <input type="date" id="startDate" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm border" />
                            </div>
                            <div>
                                <label htmlFor="endDate" className="block text-sm font-medium text-slate-700">A</label>
                                <input type="date" id="endDate" value={endDate} onChange={(e) => setEndDate(e.target.value)} min={startDate} className="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm border" />
                            </div>
                        </div>
                    </div>
                    {isFiltered && <div className="mt-4 flex justify-end"><button onClick={handleReset} className="inline-flex items-center rounded-md border border-transparent bg-slate-100 px-3 py-2 text-sm font-medium leading-4 text-slate-700 hover:bg-slate-200"><XCircleIcon /> Resetta Filtri</button></div>}
                </div>
            );
        };
        const OrderForm = ({ onSave, onCancel, initialOrder }) => {
            const [customer, setCustomer] = useState(initialOrder?.customer || '');
            const [article, setArticle] = useState(initialOrder?.article || '');
            const [quantity, setQuantity] = useState(initialOrder?.quantity || 1);
            const [salePrice, setSalePrice] = useState(initialOrder?.salePrice?.toString() || '');
            const [date, setDate] = useState(initialOrder?.date || new Date().toISOString().split('T')[0]);
            const [status, setStatus] = useState(initialOrder?.status || OrderStatus.DaIniziare);
            const [cloudLink, setCloudLink] = useState(initialOrder?.cloudLink || '');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!customer || !article || quantity <= 0 || salePrice === '' || Number(salePrice) < 0) {
                    alert('Per favore, compila tutti i campi obbligatori. Quantità e prezzo non possono essere negativi.'); return;
                }
                const orderData = { date, customer, article, status, cloudLink, quantity: Number(quantity), salePrice: Number(salePrice) };
                onSave(initialOrder ? { ...orderData, id: initialOrder.id } : orderData);
            };
            const total = (quantity > 0 && salePrice !== '' && Number(salePrice) >= 0) ? (quantity * Number(salePrice)).toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0,00';
            return (
                <form onSubmit={handleSubmit} className="p-5 space-y-4">
                    <div><label htmlFor="customer" className="block text-sm font-medium text-slate-700">Cliente *</label><input type="text" id="customer" value={customer} onChange={e => setCustomer(e.target.value)} required className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" /></div>
                    <div><label htmlFor="article" className="block text-sm font-medium text-slate-700">Articolo *</label><input type="text" id="article" value={article} onChange={e => setArticle(e.target.value)} required className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" /></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label htmlFor="quantity" className="block text-sm font-medium text-slate-700">Quantità *</label><input type="number" id="quantity" value={quantity} onChange={e => setQuantity(e.target.value === '' ? 0 : parseInt(e.target.value, 10))} min="1" required className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" /></div>
                        <div><label htmlFor="salePrice" className="block text-sm font-medium text-slate-700">Prezzo Vendita (€) *</label><input type="number" id="salePrice" value={salePrice} onChange={e => setSalePrice(e.target.value)} min="0" step="0.01" required placeholder="Es. 19.99" className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" /></div>
                    </div>
                    <div className="p-3 bg-slate-50 rounded-md text-right"><span className="text-sm font-medium text-slate-600">Totale: </span><span className="text-xl font-bold text-slate-900">€ {total}</span></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label htmlFor="date" className="block text-sm font-medium text-slate-700">Data *</label><input type="date" id="date" value={date} onChange={e => setDate(e.target.value)} required className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" /></div>
                        <div><label htmlFor="status" className="block text-sm font-medium text-slate-700">Stato *</label><select id="status" value={status} onChange={e => setStatus(e.target.value)} className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">{Object.values(OrderStatus).map(s => <option key={s} value={s}>{s}</option>)}</select></div>
                    </div>
                    <div><label htmlFor="cloudLink" className="block text-sm font-medium text-slate-700">Link Cloud (Opzionale)</label><input type="url" id="cloudLink" value={cloudLink} onChange={e => setCloudLink(e.target.value)} placeholder="https://..." className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" /></div>
                    <div className="flex justify-end space-x-3 pt-4"><button type="button" onClick={onCancel} className="px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50">Annulla</button><button type="submit" className="px-4 py-2 bg-blue-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700">Salva Ordine</button></div>
                </form>
            );
        };
        const OrderItem = ({ order, onEdit, onDelete }) => {
            const statusColors = { [OrderStatus.DaIniziare]: 'bg-slate-100 text-slate-800', [OrderStatus.InSvolgimento]: 'bg-yellow-100 text-yellow-800', [OrderStatus.Terminato]: 'bg-green-100 text-green-800' };
            const total = order.quantity * order.salePrice;
            return (
                <div className="bg-white rounded-lg shadow-md overflow-hidden transition-shadow duration-300 hover:shadow-xl">
                    <div className="p-5">
                        <div className="flex justify-between items-start gap-3">
                            <div className="flex-1"><h3 className="text-xl font-bold text-slate-800">{order.customer}</h3><p className="text-sm text-slate-500">{formatDate(order.date)}</p></div>
                            <span className={`px-3 py-1 text-xs sm:text-sm font-semibold rounded-full ${statusColors[order.status]} whitespace-nowrap`}>{order.status}</span>
                        </div>
                        <div className="mt-4 border-t border-slate-200 pt-4 space-y-2">
                            <p className="text-slate-700"><span className="font-semibold">Articolo:</span> {order.article}</p>
                            <div className="grid grid-cols-3 gap-4 text-center md:text-left">
                                <div><p className="text-sm text-slate-500">Quantità</p><p className="font-semibold text-slate-800">{order.quantity}</p></div>
                                <div><p className="text-sm text-slate-500">Prezzo Unit.</p><p className="font-semibold text-slate-800">{formatCurrency(order.salePrice)}</p></div>
                                <div><p className="text-sm text-slate-500">Totale</p><p className="font-bold text-slate-900 text-lg">{formatCurrency(total)}</p></div>
                            </div>
                            {order.cloudLink && <div className="mt-3 flex items-center space-x-2 border-t border-slate-100 pt-3"><LinkIcon /><a href={order.cloudLink} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800 hover:underline truncate text-sm">{order.cloudLink}</a></div>}
                        </div>
                    </div>
                    <div className="bg-slate-50 px-5 py-3 flex justify-end space-x-1"><button onClick={() => onEdit(order)} className="p-2 text-slate-500 hover:text-blue-700 hover:bg-blue-100 rounded-full" title="Modifica"><EditIcon /></button><button onClick={() => onDelete(order.id)} className="p-2 text-slate-500 hover:text-red-700 hover:bg-red-100 rounded-full" title="Elimina"><TrashIcon /></button></div>
                </div>
            );
        };
        const OrdersView = () => {
            const [orders, setOrders] = useLocalStorage('orders', []);
            const [isFormVisible, setIsFormVisible] = useState(false);
            const [editingOrder, setEditingOrder] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [statusFilter, setStatusFilter] = useState('all');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');

            const handleSaveOrder = (orderToSave) => {
                if (orderToSave.id) {
                    setOrders(orders.map(o => o.id === orderToSave.id ? orderToSave : o));
                } else {
                    setOrders([...orders, { ...orderToSave, id: new Date().toISOString() }]);
                }
                setIsFormVisible(false);
            };
            const handleDeleteOrder = (id) => { if (window.confirm("Sei sicuro di voler eliminare questo ordine?")) setOrders(orders.filter(o => o.id !== id)); };
            const handleEditOrder = (order) => { setEditingOrder(order); setIsFormVisible(true); };

            const filteredOrders = orders.filter(order => {
                const searchTermLower = searchTerm.toLowerCase();
                const matchesSearch = !searchTermLower || order.customer.toLowerCase().includes(searchTermLower) || order.article.toLowerCase().includes(searchTermLower);
                const matchesStatus = statusFilter === 'all' || order.status === statusFilter;
                const matchesStartDate = !startDate || order.date >= startDate;
                const matchesEndDate = !endDate || order.date <= endDate;
                return matchesSearch && matchesStatus && matchesStartDate && matchesEndDate;
            }).sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

            const handleExportExcel = () => {
                const dataToExport = filteredOrders.map(o => ({ 'Data': formatDate(o.date), 'Cliente': o.customer, 'Articolo': o.article, 'Quantità': o.quantity, 'Prezzo Vendita (€)': o.salePrice, 'Totale (€)': o.quantity * o.salePrice, 'Stato': o.status, 'Link Cloud': o.cloudLink || '' }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Ordini");
                XLSX.writeFile(workbook, `ordini_${new Date().toISOString().split('T')[0]}.xlsx`);
            };
            const handleExportPdf = () => {
                const doc = new jspdf.jsPDF();
                doc.autoTable({ head: [['Data', 'Cliente', 'Articolo', 'Qtà', 'Prezzo', 'Totale', 'Stato']], body: filteredOrders.map(o => [formatDate(o.date), o.customer, o.article, o.quantity, formatCurrency(o.salePrice), formatCurrency(o.quantity * o.salePrice), o.status]) });
                doc.save(`ordini_${new Date().toISOString().split('T')[0]}.pdf`);
            };

            return (
                <React.Fragment>
                    <OrderFilterControls {...{ searchTerm, setSearchTerm, statusFilter, setStatusFilter, startDate, setStartDate, endDate, setEndDate }} />
                    <div className="flex justify-end gap-2 mb-4">
                        <button onClick={handleExportExcel} disabled={filteredOrders.length === 0} className="inline-flex items-center rounded-md border border-transparent bg-green-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"><FileDownloadIcon className="h-5 w-5 mr-1" /> Excel</button>
                        <button onClick={handleExportPdf} disabled={filteredOrders.length === 0} className="inline-flex items-center rounded-md border border-transparent bg-red-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed"><FileDownloadIcon className="h-5 w-5 mr-1" /> PDF</button>
                    </div>
                    {filteredOrders.length > 0 ? (
                        <div className="space-y-4">{filteredOrders.map(order => <OrderItem key={order.id} order={order} onEdit={handleEditOrder} onDelete={handleDeleteOrder} />)}</div>
                    ) : (
                        <div className="text-center py-16 px-4 bg-white rounded-lg shadow"><h2 className="text-xl font-semibold text-slate-700">{orders.length > 0 ? 'Nessun ordine corrisponde ai filtri' : 'Nessun ordine trovato.'}</h2><p className="text-slate-500 mt-2">{orders.length > 0 ? 'Prova a modificare o reimpostare i filtri.' : "Premi il pulsante '+' per creare un nuovo ordine."}</p></div>
                    )}
                    {isFormVisible && <Modal title={editingOrder ? 'Modifica Ordine' : 'Nuovo Ordine'} onClose={() => setIsFormVisible(false)}><OrderForm onSave={handleSaveOrder} onCancel={() => setIsFormVisible(false)} initialOrder={editingOrder} /></Modal>}
                    <button onClick={() => { setEditingOrder(null); setIsFormVisible(true); }} className="fixed bottom-6 right-6 bg-blue-600 text-white rounded-full p-4 shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform duration-200 ease-in-out hover:scale-110 z-30" aria-label="Aggiungi Ordine"><PlusIcon /></button>
                </React.Fragment>
            );
        };

        // =================================================================
        // EXPENSES VIEW
        // =================================================================
        const ExpenseFilterControls = ({ searchTerm, setSearchTerm, startDate, setStartDate, endDate, setEndDate }) => {
            const handleReset = () => { setSearchTerm(''); setStartDate(''); setEndDate(''); };
            const isFiltered = searchTerm || startDate || endDate;
            return (
                <div className="bg-white p-4 rounded-lg shadow mb-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                        <div>
                            <label htmlFor="search-expense" className="block text-sm font-medium text-slate-700">Cerca Descrizione</label>
                            <div className="relative mt-1">
                                <div className="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><SearchIcon /></div>
                                <input type="text" id="search-expense" placeholder="Cerca..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="block w-full rounded-md border-slate-300 py-2 pl-10 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm border" />
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                            <div><label htmlFor="startDate-expense" className="block text-sm font-medium text-slate-700">Da</label><input type="date" id="startDate-expense" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm border" /></div>
                            <div><label htmlFor="endDate-expense" className="block text-sm font-medium text-slate-700">A</label><input type="date" id="endDate-expense" value={endDate} onChange={(e) => setEndDate(e.target.value)} min={startDate} className="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm border" /></div>
                        </div>
                    </div>
                    {isFiltered && <div className="mt-4 flex justify-end"><button onClick={handleReset} className="inline-flex items-center rounded-md border border-transparent bg-slate-100 px-3 py-2 text-sm font-medium leading-4 text-slate-700 hover:bg-slate-200"><XCircleIcon /> Resetta Filtri</button></div>}
                </div>
            );
        };
        const ExpenseForm = ({ onSave, onCancel, initialExpense }) => {
            const [description, setDescription] = useState(initialExpense?.description || '');
            const [quantity, setQuantity] = useState(initialExpense?.quantity || 1);
            const [price, setPrice] = useState(initialExpense?.price?.toString() || '');
            const [date, setDate] = useState(initialExpense?.date || new Date().toISOString().split('T')[0]);
            const handleSubmit = (e) => {
                e.preventDefault();
                if (!description || quantity <= 0 || price === '' || Number(price) < 0) { alert('Per favore, compila tutti i campi obbligatori. Quantità e prezzo non possono essere negativi.'); return; }
                const expenseData = { date, description, quantity: Number(quantity), price: Number(price) };
                onSave(initialExpense ? { ...expenseData, id: initialExpense.id } : expenseData);
            };
            const total = (quantity > 0 && price !== '' && Number(price) >= 0) ? (quantity * Number(price)).toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0,00';
            return (
                <form onSubmit={handleSubmit} className="p-5 space-y-4">
                    <div><label htmlFor="description" className="block text-sm font-medium text-slate-700">Descrizione *</label><textarea id="description" value={description} onChange={e => setDescription(e.target.value)} required rows={3} className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500" /></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label htmlFor="quantity" className="block text-sm font-medium text-slate-700">Quantità *</label><input type="number" id="quantity" value={quantity} onChange={e => setQuantity(e.target.value === '' ? 0 : parseInt(e.target.value, 10))} min="1" required className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500" /></div>
                        <div><label htmlFor="price" className="block text-sm font-medium text-slate-700">Prezzo (€) *</label><input type="number" id="price" value={price} onChange={e => setPrice(e.target.value)} min="0" step="0.01" required placeholder="Es. 19.99" className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500" /></div>
                    </div>
                    <div className="p-3 bg-slate-50 rounded-md text-right"><span className="text-sm font-medium text-slate-600">Totale: </span><span className="text-xl font-bold text-slate-900">€ {total}</span></div>
                    <div><label htmlFor="date" className="block text-sm font-medium text-slate-700">Data *</label><input type="date" id="date" value={date} onChange={e => setDate(e.target.value)} required className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500" /></div>
                    <div className="flex justify-end space-x-3 pt-4"><button type="button" onClick={onCancel} className="px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50">Annulla</button><button type="submit" className="px-4 py-2 bg-emerald-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-emerald-700">Salva Spesa</button></div>
                </form>
            );
        };
        const ExpenseItem = ({ expense, onEdit, onDelete }) => {
            const total = expense.quantity * expense.price;
            return (
                <div className="bg-white rounded-lg shadow-md overflow-hidden transition-shadow duration-300 hover:shadow-xl">
                    <div className="p-5">
                        <div className="flex justify-between items-start gap-3"><h3 className="text-lg font-bold text-slate-800 flex-1 pr-4">{expense.description}</h3><p className="text-sm text-slate-500 whitespace-nowrap">{formatDate(expense.date)}</p></div>
                        <div className="mt-4 border-t border-slate-200 pt-4">
                            <div className="grid grid-cols-3 gap-4 text-center md:text-left">
                                <div><p className="text-sm text-slate-500">Quantità</p><p className="font-semibold text-slate-800">{expense.quantity}</p></div>
                                <div><p className="text-sm text-slate-500">Prezzo Unit.</p><p className="font-semibold text-slate-800">{formatCurrency(expense.price)}</p></div>
                                <div><p className="text-sm text-slate-500">Totale</p><p className="font-bold text-slate-900 text-lg">{formatCurrency(total)}</p></div>
                            </div>
                        </div>
                    </div>
                    <div className="bg-slate-50 px-5 py-3 flex justify-end space-x-1"><button onClick={() => onEdit(expense)} className="p-2 text-slate-500 hover:text-emerald-700 hover:bg-emerald-100 rounded-full" title="Modifica"><EditIcon /></button><button onClick={() => onDelete(expense.id)} className="p-2 text-slate-500 hover:text-red-700 hover:bg-red-100 rounded-full" title="Elimina"><TrashIcon /></button></div>
                </div>
            );
        };
        const ExpensesView = () => {
            const [expenses, setExpenses] = useLocalStorage('expenses', []);
            const [isFormVisible, setIsFormVisible] = useState(false);
            const [editingExpense, setEditingExpense] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');

            const handleSaveExpense = (expenseToSave) => {
                if (expenseToSave.id) {
                    setExpenses(expenses.map(e => e.id === expenseToSave.id ? expenseToSave : e));
                } else {
                    setExpenses([...expenses, { ...expenseToSave, id: new Date().toISOString() }]);
                }
                setIsFormVisible(false);
            };
            const handleDeleteExpense = (id) => { if (window.confirm("Sei sicuro di voler eliminare questa spesa?")) setExpenses(expenses.filter(e => e.id !== id)); };
            const handleEditExpense = (expense) => { setEditingExpense(expense); setIsFormVisible(true); };

            const filteredExpenses = expenses.filter(expense => {
                const searchTermLower = searchTerm.toLowerCase();
                const matchesSearch = !searchTermLower || expense.description.toLowerCase().includes(searchTermLower);
                const matchesStartDate = !startDate || expense.date >= startDate;
                const matchesEndDate = !endDate || expense.date <= endDate;
                return matchesSearch && matchesStartDate && matchesEndDate;
            }).sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
            
            const handleExportExcel = () => {
                const dataToExport = filteredExpenses.map(e => ({ 'Data': formatDate(e.date), 'Descrizione': e.description, 'Quantità': e.quantity, 'Prezzo (€)': e.price, 'Totale (€)': e.quantity * e.price }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Spese");
                XLSX.writeFile(workbook, `spese_${new Date().toISOString().split('T')[0]}.xlsx`);
            };
            const handleExportPdf = () => {
                const doc = new jspdf.jsPDF();
                doc.autoTable({ head: [['Data', 'Descrizione', 'Qtà', 'Prezzo', 'Totale']], body: filteredExpenses.map(e => [formatDate(e.date), e.description, e.quantity, formatCurrency(e.price), formatCurrency(e.quantity * e.price)]) });
                doc.save(`spese_${new Date().toISOString().split('T')[0]}.pdf`);
            };

            return (
                <React.Fragment>
                    <ExpenseFilterControls {...{ searchTerm, setSearchTerm, startDate, setStartDate, endDate, setEndDate }} />
                    <div className="flex justify-end gap-2 mb-4">
                        <button onClick={handleExportExcel} disabled={filteredExpenses.length === 0} className="inline-flex items-center rounded-md border border-transparent bg-green-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"><FileDownloadIcon className="h-5 w-5 mr-1" /> Excel</button>
                        <button onClick={handleExportPdf} disabled={filteredExpenses.length === 0} className="inline-flex items-center rounded-md border border-transparent bg-red-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed"><FileDownloadIcon className="h-5 w-5 mr-1" /> PDF</button>
                    </div>
                    {filteredExpenses.length > 0 ? (
                        <div className="space-y-4">{filteredExpenses.map(expense => <ExpenseItem key={expense.id} expense={expense} onEdit={handleEditExpense} onDelete={handleDeleteExpense} />)}</div>
                    ) : (
                        <div className="text-center py-16 px-4 bg-white rounded-lg shadow"><h2 className="text-xl font-semibold text-slate-700">{expenses.length > 0 ? 'Nessuna spesa corrisponde ai filtri' : 'Nessuna spesa trovata.'}</h2><p className="text-slate-500 mt-2">{expenses.length > 0 ? 'Prova a modificare o reimpostare i filtri.' : "Premi il pulsante '+' per creare una nuova spesa."}</p></div>
                    )}
                    {isFormVisible && <Modal title={editingExpense ? 'Modifica Spesa' : 'Nuova Spesa'} onClose={() => setIsFormVisible(false)}><ExpenseForm onSave={handleSaveExpense} onCancel={() => setIsFormVisible(false)} initialExpense={editingExpense} /></Modal>}
                    <button onClick={() => { setEditingExpense(null); setIsFormVisible(true); }} className="fixed bottom-6 right-6 bg-emerald-600 text-white rounded-full p-4 shadow-lg hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-transform duration-200 ease-in-out hover:scale-110 z-30" aria-label="Aggiungi Spesa"><PlusIcon /></button>
                </React.Fragment>
            );
        };

        // =================================================================
        // STOCKS VIEW
        // =================================================================
        const StockFilterControls = ({ searchTerm, setSearchTerm, quantityFilter, setQuantityFilter, hasImage, setHasImage }) => {
            const handleReset = () => { setSearchTerm(''); setQuantityFilter('all'); setHasImage('all'); };
            const isFiltered = searchTerm || quantityFilter !== 'all' || hasImage !== 'all';
            return (
                <div className="bg-white p-4 rounded-lg shadow mb-6">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div className="md:col-span-3 lg:col-span-1">
                            <label htmlFor="search-stock" className="block text-sm font-medium text-slate-700">Cerca Codice o Descrizione</label>
                            <div className="relative mt-1">
                                <div className="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><SearchIcon /></div>
                                <input type="text" id="search-stock" placeholder="Cerca..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="block w-full rounded-md border-slate-300 py-2 pl-10 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm border" />
                            </div>
                        </div>
                        <div>
                            <label htmlFor="quantityFilter" className="block text-sm font-medium text-slate-700">Giacenza Articolo</label>
                            <select id="quantityFilter" value={quantityFilter} onChange={(e) => setQuantityFilter(e.target.value)} className="mt-1 block w-full rounded-md border-slate-300 py-2 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm border">
                                <option value="all">Tutte</option>
                                <option value="available">Disponibili (&gt;0)</option>
                                <option value="one">Singola unità (1)</option>
                                <option value="low">Sotto soglia (&lt;5)</option>
                                <option value="zero">Esauriti (0)</option>
                            </select>
                        </div>
                        <div>
                            <label htmlFor="hasImage" className="block text-sm font-medium text-slate-700">Immagine</label>
                            <select id="hasImage" value={hasImage} onChange={(e) => setHasImage(e.target.value)} className="mt-1 block w-full rounded-md border-slate-300 py-2 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm border">
                                <option value="all">Tutte</option>
                                <option value="with">Con immagine</option>
                                <option value="without">Senza immagine</option>
                            </select>
                        </div>
                    </div>
                    {isFiltered && <div className="mt-4 flex justify-end"><button onClick={handleReset} className="inline-flex items-center rounded-md border border-transparent bg-slate-100 px-3 py-2 text-sm font-medium leading-4 text-slate-700 hover:bg-slate-200"><XCircleIcon /> Resetta Filtri</button></div>}
                </div>
            );
        };
        const StockForm = ({ onSave, onCancel, initialStock, existingCodes }) => {
            const [date, setDate] = useState(initialStock?.date || new Date().toISOString().split('T')[0]);
            const [codice, setCodice] = useState(initialStock?.codice || '');
            const [descrizione, setDescrizione] = useState(initialStock?.descrizione || '');
            const [quantity, setQuantity] = useState(initialStock?.quantity?.toString() || '1');
            const [price, setPrice] = useState(initialStock?.price?.toString() || '');
            const [thumbnail, setThumbnail] = useState(initialStock?.thumbnail || '');
            const [fullImage, setFullImage] = useState(initialStock?.fullImage || '');
            const [dragActive, setDragActive] = useState(false);
            const fileInputRef = useRef(null);

            const handleImageUpload = async (file) => {
                if (!file || !file.type.startsWith('image/')) return;
                try {
                    const thumb = await resizeImage(file, 150, 150);
                    const full = await resizeImage(file, 1200, 1200);
                    setThumbnail(thumb); setFullImage(full);
                } catch (error) { console.error('Image resize error:', error); }
            };
            const handleDrag = (e) => { e.preventDefault(); e.stopPropagation(); setDragActive(e.type === "dragenter" || e.type === "dragover"); };
            const handleDrop = (e) => { e.preventDefault(); e.stopPropagation(); setDragActive(false); if (e.dataTransfer.files?.[0]) handleImageUpload(e.dataTransfer.files[0]); };
            const handleSubmit = (e) => {
                e.preventDefault();
                if (!date || !codice || !descrizione || quantity === '') { alert('Compila tutti i campi obbligatori.'); return; }
                if (!initialStock?.id && existingCodes.includes(codice.toUpperCase()) && !confirm(`Il codice "${codice}" esiste già. Continuare?`)) return;
                const stockData = { date, codice: codice.toUpperCase(), descrizione, quantity: Number(quantity), price: price === '' ? null : Number(price), thumbnail, fullImage };
                onSave(initialStock?.id ? { ...stockData, id: initialStock.id } : stockData);
            };
            const total = (quantity !== '' && price !== '' && !isNaN(Number(quantity)) && !isNaN(Number(price))) ? (Number(quantity) * Number(price)) : null;
            return (
                <form onSubmit={handleSubmit} className="p-5 space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label htmlFor="date" className="block text-sm font-medium text-slate-700">Data *</label><input type="date" id="date" value={date} onChange={e => setDate(e.target.value)} required className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500" /></div>
                        <div><label htmlFor="codice" className="block text-sm font-medium text-slate-700">Codice * {initialStock?.id && <span className="text-xs text-slate-500">(non modificabile)</span>}</label><input type="text" id="codice" value={codice} onChange={e => setCodice(e.target.value)} disabled={!!initialStock?.id} required className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 disabled:bg-slate-100" /></div>
                    </div>
                    <div><label htmlFor="descrizione" className="block text-sm font-medium text-slate-700">Descrizione *</label><input type="text" id="descrizione" value={descrizione} onChange={e => setDescrizione(e.target.value)} required className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500" /></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label htmlFor="quantity" className="block text-sm font-medium text-slate-700">Quantità *</label><input type="number" id="quantity" value={quantity} onChange={e => setQuantity(e.target.value)} required className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500" /><p className="mt-1 text-xs text-slate-500">Usa numeri negativi per scarichi</p></div>
                        <div><label htmlFor="price" className="block text-sm font-medium text-slate-700">Prezzo (€)</label><input type="number" id="price" value={price} onChange={e => setPrice(e.target.value)} min="0" step="0.01" placeholder="Opzionale" className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500" /></div>
                    </div>
                    <div className="p-3 bg-purple-50 rounded-md text-right"><span className="text-sm font-medium text-slate-600">Totale riga: </span><span className="text-xl font-bold text-slate-900">{formatCurrency(total)}</span></div>
                    <div>
                        <label className="block text-sm font-medium text-slate-700 mb-2">Immagine</label>
                        <div onDragEnter={handleDrag} onDragLeave={handleDrag} onDragOver={handleDrag} onDrop={handleDrop} className={`border-2 border-dashed rounded-lg p-6 text-center transition-colors ${dragActive ? 'border-purple-500 bg-purple-50' : 'border-slate-300'}`}>
                            {thumbnail ? (<div className="space-y-3"><img src={thumbnail} alt="Anteprima" className="mx-auto rounded-lg" style={{ maxWidth: '150px' }} /><div className="flex justify-center gap-2"><button type="button" onClick={() => fileInputRef.current?.click()} className="px-3 py-1 text-sm bg-purple-600 text-white rounded hover:bg-purple-700">Cambia</button><button type="button" onClick={() => { setThumbnail(''); setFullImage(''); }} className="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700">Rimuovi</button></div></div>) : (<div className="space-y-2 flex flex-col items-center"><CameraIcon /><p className="text-sm text-slate-600">Trascina un'immagine qui o</p><button type="button" onClick={() => fileInputRef.current?.click()} className="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">Seleziona File</button></div>)}
                            <input ref={fileInputRef} type="file" accept="image/*" capture="environment" onChange={(e) => e.target.files?.[0] && handleImageUpload(e.target.files[0])} className="hidden" />
                        </div>
                    </div>
                    <div className="flex justify-end space-x-3 pt-4"><button type="button" onClick={onCancel} className="px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50">Annulla</button><button type="submit" className="px-4 py-2 bg-purple-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-purple-700">Salva</button></div>
                </form>
            );
        };
        const StockItem = ({ movement, onEdit, onDelete, onDuplicate, onAdjustQuantity, onImageClick }) => {
            const total = movement.price !== null ? movement.quantity * movement.price : null;
            const quantityColor = movement.quantity >= 0 ? 'text-green-600' : 'text-red-600';
            return (
                <div className="bg-white rounded-lg shadow-md overflow-hidden transition-shadow duration-300 hover:shadow-xl">
                    <div className="p-5">
                        <div className="flex items-start gap-4">
                            {movement.thumbnail && <img src={movement.thumbnail} alt={movement.descrizione} className="thumbnail-image cursor-pointer" onClick={() => onImageClick(movement.fullImage || movement.thumbnail)} />}
                            <div className="flex-1 min-w-0">
                                <h3 className="text-lg font-bold text-slate-800 truncate">{movement.codice}</h3>
                                <p className="text-slate-600 truncate">{movement.descrizione}</p>
                                <p className="text-sm text-slate-500 mt-1">{formatDate(movement.date)}</p>
                            </div>
                            <div className="text-right shrink-0">
                                <p className={`text-2xl font-bold ${quantityColor}`}>{movement.quantity > 0 ? `+${movement.quantity}`: movement.quantity}</p>
                                <p className="text-xs text-slate-500">Movimento</p>
                            </div>
                        </div>
                        <div className="mt-4 border-t border-slate-200 pt-4 grid grid-cols-2 gap-4 text-sm">
                            <div><span className="text-slate-500">Prezzo Unit.:</span><p className="font-semibold">{formatCurrency(movement.price)}</p></div>
                            <div><span className="text-slate-500">Valore Riga:</span><p className="font-semibold">{formatCurrency(total)}</p></div>
                        </div>
                    </div>
                    <div className="bg-slate-50 px-5 py-3 flex justify-end items-center gap-1">
                        <button onClick={() => onDuplicate(movement)} className="p-2 text-slate-500 hover:bg-slate-200 rounded-full" title="Duplica Movimento"><CopyIcon /></button>
                        <button onClick={() => onEdit(movement)} className="p-2 text-slate-500 hover:bg-slate-200 rounded-full" title="Modifica Movimento"><EditIcon /></button>
                        <button onClick={() => onDelete(movement.id)} className="p-2 text-red-500 hover:bg-red-100 rounded-full" title="Elimina Movimento"><TrashIcon /></button>
                    </div>
                </div>
            );
        };
        const StocksView = () => {
            const [stocks, setStocks] = useLocalStorage('stocks', []); // This is an array of StockMovement
            const [isFormVisible, setIsFormVisible] = useState(false);
            const [editingStock, setEditingStock] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [quantityFilter, setQuantityFilter] = useState('all');
            const [hasImage, setHasImage] = useState('all');
            const [lightboxImage, setLightboxImage] = useState(null);
            const [undoStack, setUndoStack] = useState([]);

            useEffect(() => {
                if (undoStack.length > 0) {
                    const timer = setTimeout(() => setUndoStack([]), 5000);
                    return () => clearTimeout(timer);
                }
            }, [undoStack]);
            
            const handleSaveStock = (stockToSave) => {
                if (stockToSave.id) {
                    setStocks(stocks.map(s => s.id === stockToSave.id ? stockToSave : s));
                } else {
                    setStocks(prev => [...prev, { ...stockToSave, id: new Date().toISOString() }]);
                }
                setIsFormVisible(false);
                setEditingStock(null);
            };
            const handleDeleteStock = (id) => {
                const stockToDelete = stocks.find(s => s.id === id);
                if (stockToDelete && window.confirm(`Sei sicuro di voler eliminare il movimento per "${stockToDelete.codice}"?`)) {
                    setUndoStack(prev => [...prev.filter(u => u.stock.id !== id), { action: 'delete', stock: stockToDelete }]);
                    setStocks(stocks.filter(s => s.id !== id));
                }
            };
            const handleUndo = () => {
                const lastAction = undoStack.pop();
                if (lastAction?.action === 'delete') setStocks(prev => [...prev, lastAction.stock]);
                setUndoStack([...undoStack]);
            };
            const handleEditStock = (stock) => { setEditingStock(stock); setIsFormVisible(true); };
            const handleDuplicateStock = (stock) => { setEditingStock({ ...stock, id: undefined, date: new Date().toISOString().split('T')[0] }); setIsFormVisible(true); };
            
            const aggregatedStocks = stocks.reduce((acc, stock) => {
                const key = stock.codice.toUpperCase();
                if (!acc[key]) acc[key] = { codice: stock.codice, totalQuantity: 0, thumbnail: stock.thumbnail, fullImage: stock.fullImage, descrizione: stock.descrizione };
                acc[key].totalQuantity += stock.quantity;
                if (!acc[key].thumbnail && stock.thumbnail) acc[key].thumbnail = stock.thumbnail;
                if (!acc[key].descrizione && stock.descrizione) acc[key].descrizione = stock.descrizione;
                return acc;
            }, {});

            const filteredMovements = stocks.filter(movement => {
                const stockData = aggregatedStocks[movement.codice.toUpperCase()];
                if (!stockData) return false;
                
                const searchTermLower = searchTerm.toLowerCase();
                const matchesSearch = !searchTermLower || movement.codice.toLowerCase().includes(searchTermLower) || movement.descrizione.toLowerCase().includes(searchTermLower);
                
                const matchesQuantity = quantityFilter === 'all' || 
                    (quantityFilter === 'zero' && stockData.totalQuantity === 0) || 
                    (quantityFilter === 'low' && stockData.totalQuantity > 0 && stockData.totalQuantity < 5) || 
                    (quantityFilter === 'available' && stockData.totalQuantity > 0) ||
                    (quantityFilter === 'one' && stockData.totalQuantity === 1);
                
                const matchesImage = hasImage === 'all' || (hasImage === 'with' && !!movement.thumbnail) || (hasImage === 'without' && !movement.thumbnail);
                
                return matchesSearch && matchesQuantity && matchesImage;
            }).sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
            
            const totalStats = Object.values(aggregatedStocks).reduce((acc, s) => {
                acc.uniqueItems += 1;
                acc.totalQuantity += s.totalQuantity;
                return acc;
            }, { uniqueItems: 0, totalQuantity: 0 });

            const existingCodes = [...new Set(stocks.map(s => s.codice.toUpperCase()))];
            
            const handleExportExcel = () => {
                const dataToExport = Object.values(aggregatedStocks).map(s => ({ 'Codice': s.codice, 'Descrizione': s.descrizione, 'Quantità Totale': s.totalQuantity }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                XLSX.utils.book_append_sheet(XLSX.utils.book_new(), worksheet, "Scorte");
                XLSX.writeFile(workbook, `scorte_inventario_${new Date().toISOString().split('T')[0]}.xlsx`);
            };
            const handleExportPdf = () => {
                const doc = new jspdf.jsPDF();
                doc.autoTable({ head: [['Codice', 'Descrizione', 'Quantità Totale']], body: Object.values(aggregatedStocks).map(s => [s.codice, s.descrizione, s.totalQuantity]) });
                doc.save(`scorte_inventario_${new Date().toISOString().split('T')[0]}.pdf`);
            };

            return (
                <React.Fragment>
                    <StockFilterControls {...{ searchTerm, setSearchTerm, quantityFilter, setQuantityFilter, hasImage, setHasImage }} />
                    <div className="flex justify-end gap-2 mb-4">
                        <button onClick={handleExportExcel} disabled={Object.keys(aggregatedStocks).length === 0} className="inline-flex items-center rounded-md border border-transparent bg-green-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"><FileDownloadIcon className="h-5 w-5 mr-1" /> Excel</button>
                        <button onClick={handleExportPdf} disabled={Object.keys(aggregatedStocks).length === 0} className="inline-flex items-center rounded-md border border-transparent bg-red-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed"><FileDownloadIcon className="h-5 w-5 mr-1" /> PDF</button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div className="bg-white rounded-lg shadow p-4"><p className="text-sm text-slate-600">Articoli Unici</p><p className="text-2xl font-bold text-purple-600">{totalStats.uniqueItems}</p></div>
                        <div className="bg-white rounded-lg shadow p-4"><p className="text-sm text-slate-600">Quantità Totale</p><p className="text-2xl font-bold text-slate-900">{totalStats.totalQuantity}</p></div>
                    </div>
                    {undoStack.length > 0 && <div className="mb-4 bg-slate-800 text-white px-4 py-3 rounded-lg flex justify-between items-center"><span className="text-sm">Movimento eliminato</span><button onClick={handleUndo} className="px-3 py-1 bg-white text-slate-800 rounded text-sm font-medium hover:bg-slate-100">Annulla</button></div>}
                    
                    {filteredMovements.length > 0 ? (
                        <div className="space-y-4">{filteredMovements.map(movement => <StockItem key={movement.id} {...{ movement, onEdit: handleEditStock, onDelete: handleDeleteStock, onDuplicate: handleDuplicateStock, onImageClick: setLightboxImage }} />)}</div>
                    ) : (
                        <div className="text-center py-16 px-4 bg-white rounded-lg shadow"><h2 className="text-xl font-semibold text-slate-700">{stocks.length > 0 ? 'Nessun movimento corrisponde ai filtri' : 'Nessun movimento in magazzino.'}</h2><p className="text-slate-500 mt-2">{stocks.length > 0 ? 'Prova a modificare i filtri.' : "Premi '+' per aggiungere un movimento."}</p></div>
                    )}

                    {isFormVisible && <Modal title={editingStock?.id ? 'Modifica Movimento' : 'Nuovo Movimento'} onClose={() => setIsFormVisible(false)}><StockForm onSave={handleSaveStock} onCancel={() => setIsFormVisible(false)} initialStock={editingStock} existingCodes={existingCodes} /></Modal>}
                    {lightboxImage && <ImageLightbox imageUrl={lightboxImage} onClose={() => setLightboxImage(null)} />}
                    <button onClick={() => { setEditingStock(null); setIsFormVisible(true); }} className="fixed bottom-6 right-6 bg-purple-600 text-white rounded-full p-4 shadow-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-transform duration-200 ease-in-out hover:scale-110 z-30" aria-label="Aggiungi Movimento"><PlusIcon /></button>
                </React.Fragment>
            );
        };

        // =================================================================
        // MAIN APP COMPONENT
        // =================================================================
        const App = () => {
            const [activeTab, setActiveTab] = useState('stocks');
            const tabConfig = {
                orders: { label: 'Ordini', color: 'blue', buttonClass: 'bg-blue-600 focus:ring-blue-500' },
                expenses: { label: 'Spese', color: 'emerald', buttonClass: 'bg-emerald-600 focus:ring-emerald-500' },
                stocks: { label: 'Scorte', color: 'purple', buttonClass: 'bg-purple-600 focus:ring-purple-500' },
            };
            const getTabClasses = (tabName) => {
                const isActive = activeTab === tabName;
                const baseClasses = 'px-3 sm:px-4 py-2 text-sm sm:text-base font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all duration-200 ease-in-out whitespace-nowrap';
                if (isActive) return `${baseClasses} text-white shadow-md ${tabConfig[tabName].buttonClass}`;
                return `${baseClasses} text-slate-600 hover:bg-slate-200 hover:text-slate-800 focus:ring-${tabConfig[tabName].color}-500`;
            };
            return (
                <div className="min-h-screen bg-slate-100 font-sans text-slate-800">
                    <header className="bg-white shadow-sm sticky top-0 z-40 w-full">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="py-4 flex flex-col sm:flex-row sm:justify-between sm:items-center">
                                <h1 className="text-2xl font-bold text-slate-900 tracking-tight text-center sm:text-left mb-3 sm:mb-0">Gestione Attività</h1>
                                <nav className="w-full sm:w-auto">
                                    <div className="bg-slate-100 p-1 rounded-lg flex space-x-1 justify-center">
                                        {Object.keys(tabConfig).map((tab) => <button key={tab} onClick={() => setActiveTab(tab)} className={getTabClasses(tab)}>{tabConfig[tab].label}</button>)}
                                    </div>
                                </nav>
                            </div>
                        </div>
                    </header>
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8 pb-28">
                        {activeTab === 'orders' && <OrdersView />}
                        {activeTab === 'expenses' && <ExpensesView />}
                        {activeTab === 'stocks' && <StocksView />}
                    </main>
                </div>
            );
        };
        
        // =================================================================
        // RENDER APP
        // =================================================================
        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(
          <StrictMode>
            <App />
          </StrictMode>
        );

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
