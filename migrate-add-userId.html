<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Migrazione userId - Eseguire UNA SOLA VOLTA</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        body {
            font-family: monospace;
            padding: 40px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #000;
            padding: 30px;
            border: 2px solid #00ff00;
            border-radius: 8px;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            margin: 10px 5px;
        }
        button:hover {
            background: #00cc00;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .warning {
            background: #ff0000;
            color: #fff;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .success {
            background: #00ff00;
            color: #000;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }
        #log {
            background: #111;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #333;
            height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
        }
        .log-info { color: #00aaff; }
        .log-success { color: #00ff00; }
        .log-error { color: #ff0000; }
        .log-warning { color: #ffaa00; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Migrazione Database - Aggiunta userId</h1>

        <div class="warning">
            <h3>‚ö†Ô∏è ATTENZIONE - LEGGERE PRIMA DI PROCEDERE</h3>
            <ul>
                <li>Questo script aggiunge il campo <code>userId</code> a TUTTI i documenti esistenti</li>
                <li>Eseguire SOLO quando sei loggato con il tuo account principale</li>
                <li>Eseguire UNA SOLA VOLTA (controlla il log prima di ripetere)</li>
                <li>Fai un backup dei dati prima di procedere</li>
            </ul>
        </div>

        <div id="auth-status" style="padding: 20px; margin: 20px 0; border: 1px solid #00ff00;">
            <h3>Stato Autenticazione:</h3>
            <div id="user-info">Caricamento...</div>
        </div>

        <div style="margin: 30px 0;">
            <button id="btnStart" disabled>üöÄ AVVIA MIGRAZIONE</button>
            <button id="btnCheck">üîç CONTROLLA DOCUMENTI SENZA userId</button>
        </div>

        <div id="log"></div>
    </div>

    <script type="module">
        // ========================================
        // FIREBASE CONFIG
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDEa6a3wvZ_-fswrwPf6mLYN4vUYJ8gJMg",
            authDomain: "business-manager-pro-8a727.firebaseapp.com",
            projectId: "business-manager-pro-8a727",
            storageBucket: "business-manager-pro-8a727.firebasestorage.app",
            messagingSenderId: "433813286926",
            appId: "1:433813286926:web:15d8a96f65999e56cdc3a3"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;

        // ========================================
        // LOGGING
        // ========================================
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // ========================================
        // AUTH LISTENER
        // ========================================
        auth.onAuthStateChanged(user => {
            const userInfo = document.getElementById('user-info');
            const btnStart = document.getElementById('btnStart');

            if (user) {
                currentUser = user;
                userInfo.innerHTML = `
                    ‚úÖ Loggato come: <strong>${user.email}</strong><br>
                    User ID: <code>${user.uid}</code>
                `;
                btnStart.disabled = false;
                log(`Autenticato come: ${user.email}`, 'success');
            } else {
                userInfo.innerHTML = '‚ùå Non sei loggato. Apri l\'app principale e torna qui.';
                btnStart.disabled = true;
                log('Non autenticato. Login richiesto.', 'error');
            }
        });

        // ========================================
        // CHECK DOCUMENTS WITHOUT userId
        // ========================================
        async function checkMissingUserId() {
            log('üîç Inizio controllo documenti senza userId...', 'info');

            const collections = ['orders', 'expenses', 'stockMovements', 'customersArchive', 'articlesArchive'];
            let totalMissing = 0;

            for (const collName of collections) {
                try {
                    const snapshot = await db.collection(collName).get();
                    const missing = snapshot.docs.filter(doc => !doc.data().userId);

                    if (missing.length > 0) {
                        log(`‚ö†Ô∏è  ${collName}: ${missing.length} documenti senza userId`, 'warning');
                        totalMissing += missing.length;
                    } else {
                        log(`‚úÖ ${collName}: Tutti i documenti hanno userId`, 'success');
                    }
                } catch (error) {
                    log(`‚ùå Errore su ${collName}: ${error.message}`, 'error');
                }
            }

            if (totalMissing > 0) {
                log(`\nüìä TOTALE: ${totalMissing} documenti da migrare`, 'warning');
            } else {
                log(`\n‚úÖ PERFETTO! Tutti i documenti hanno gi√† userId`, 'success');
            }
        }

        // ========================================
        // MIGRATION FUNCTION
        // ========================================
        async function runMigration() {
            if (!currentUser) {
                alert('Devi essere loggato per eseguire la migrazione!');
                return;
            }

            const confirmed = confirm(
                `‚ö†Ô∏è CONFERMA MIGRAZIONE\n\n` +
                `Stai per aggiungere il tuo userId (${currentUser.uid}) a TUTTI i documenti.\n\n` +
                `Utente: ${currentUser.email}\n\n` +
                `Sei sicuro? Questa operazione non pu√≤ essere annullata facilmente.`
            );

            if (!confirmed) {
                log('Migrazione annullata dall\'utente', 'warning');
                return;
            }

            log('üöÄ AVVIO MIGRAZIONE...', 'info');
            document.getElementById('btnStart').disabled = true;

            const collections = ['orders', 'expenses', 'stockMovements', 'customersArchive', 'articlesArchive'];
            let totalUpdated = 0;
            let totalErrors = 0;

            for (const collName of collections) {
                log(`\nüì¶ Migrazione collezione: ${collName}`, 'info');

                try {
                    const snapshot = await db.collection(collName).get();
                    log(`   Trovati ${snapshot.docs.length} documenti`, 'info');

                    let updated = 0;
                    let skipped = 0;

                    for (const doc of snapshot.docs) {
                        const data = doc.data();

                        if (data.userId) {
                            log(`   ‚è≠Ô∏è  Skipped ${doc.id} (ha gi√† userId)`, 'info');
                            skipped++;
                            continue;
                        }

                        try {
                            await doc.ref.update({
                                userId: currentUser.uid,
                                migratedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            log(`   ‚úÖ Aggiornato ${doc.id}`, 'success');
                            updated++;
                            totalUpdated++;
                        } catch (error) {
                            log(`   ‚ùå Errore su ${doc.id}: ${error.message}`, 'error');
                            totalErrors++;
                        }
                    }

                    log(`   üìä ${collName}: ${updated} aggiornati, ${skipped} saltati`, 'success');

                } catch (error) {
                    log(`‚ùå Errore fatale su ${collName}: ${error.message}`, 'error');
                    totalErrors++;
                }
            }

            log('\n' + '='.repeat(60), 'info');
            log('‚úÖ MIGRAZIONE COMPLETATA!', 'success');
            log(`üìä Documenti aggiornati: ${totalUpdated}`, 'success');
            if (totalErrors > 0) {
                log(`‚ö†Ô∏è  Errori riscontrati: ${totalErrors}`, 'error');
            }
            log('='.repeat(60), 'info');

            document.getElementById('btnStart').disabled = false;
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================
        document.getElementById('btnStart').addEventListener('click', runMigration);
        document.getElementById('btnCheck').addEventListener('click', checkMissingUserId);

        log('üîß Script di migrazione caricato', 'success');
        log('üìù Aspettando autenticazione...', 'info');
    </script>
</body>
</html>
